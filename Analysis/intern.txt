# Import necessary libraries
import pandas as pd
import sqlite3
import json

# Load CSV Data
orders_df = pd.read_csv('orders.csv')

# Load JSON Data
with open('users.json', 'r') as f:
    users_data = json.load(f)
users_df = pd.DataFrame(users_data)

# Load SQL Data
# Creating an in-memory database to parse the .sql file
conn = sqlite3.connect(':memory:')
with open('restaurants.sql', 'r') as f:
    sql_script = f.read()
conn.executescript(sql_script)
restaurants_df = pd.read_sql_query("SELECT * FROM restaurants", conn)
conn.close()


# Merge orders with users
merged_df = orders_df.merge(users_df, on='user_id', how='left')

# Merge with restaurants
final_df = merged_df.merge(restaurants_df, on='restaurant_id', how='left', suffixes=('_order', '_master'))

# Save the final dataset
final_df.to_csv('final_food_delivery_dataset.csv', index=False)
print("Final dataset created successfully!")

# 1. Total Revenue from Gold Members by City
gold_revenue = final_df[final_df['membership'] == 'Gold'].groupby('city')['total_amount'].sum()
print("\nRevenue from Gold Members by City:\n", gold_revenue)

# 2. Average Order Value by Cuisine
cuisine_aov = final_df.groupby('cuisine')['total_amount'].mean()
print("\nAverage Order Value by Cuisine:\n", cuisine_aov)

# 3. Percentage of Orders by Gold Members
gold_perc = (len(final_df[final_df['membership'] == 'Gold']) / len(final_df)) * 100
print(f"\nPercentage of Gold Member Orders: {gold_perc:.2f}%")

# 4. Quarterly Revenue Performance
final_df['order_date'] = pd.to_datetime(final_df['order_date'], dayfirst=True)
quarterly_rev = final_df.groupby(final_df['order_date'].dt.quarter)['total_amount'].sum()
print("\nRevenue by Quarter:\n", quarterly_rev)